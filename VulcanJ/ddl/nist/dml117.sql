SET NAMES ASCII;
CREATE DATABASE 'test.fdb' DEFAULT CHARACTER SET ISO8859_1;

INPUT ddl/input/base-tab.sql;
COMMIT;

-- TEST:0645 Feature 19, Referential delete actions (static)!

 CREATE TABLE LUSERS ( NAAM CHAR (10), LUSER_ID int not null primary key, FILE_QUOTA INT, FILE_USAGE INT NOT NULL, CHECK (FILE_USAGE >= 0 AND (FILE_QUOTA IS NULL OR FILE_QUOTA >= FILE_USAGE)));
 CREATE TABLE LUSER_DATA ( FILE_NAME     CHAR (8) NOT NULL, LUSER_ID int  NOT NULL  , LUSER_DATA   CHAR (30), primary key (FILE_NAME, LUSER_ID) ,  FOREIGN KEY (LUSER_ID) REFERENCES LUSERS on delete cascade);
 CREATE TABLE AUDIT_CODES ( ACTION_KEY INT not null PRIMARY KEY, LUSER_ACTION CHAR (6) NOT NULL, CHECK (LUSER_ACTION = 'INSERT' OR LUSER_ACTION = 'ACCVIO' OR LUSER_ACTION = 'DELETE'));
 CREATE TABLE ALL_USER_IDS (LUSER_ID INT UNIQUE);
 CREATE TABLE AUDIT_RECORDS ( LUSER_ID INT, SAVED_LUSER_ID INT NOT NULL REFERENCES ALL_USER_IDS (LUSER_ID) ON DELETE NO ACTION, ACTION_KEY INT DEFAULT 0 NOT NULL  REFERENCES AUDIT_CODES ON DELETE SET DEFAULT, FOREIGN KEY (LUSER_ID) REFERENCES LUSERS ON DELETE SET NULL);
 INSERT INTO AUDIT_CODES VALUES (0, 'ACCVIO');
 INSERT INTO AUDIT_CODES VALUES (1, 'INSERT');
 INSERT INTO AUDIT_CODES VALUES (2, 'DELETE');
 INSERT INTO LUSERS VALUES ('root', 0, NULL, 2);
 INSERT INTO LUSERS VALUES ('BIFF', 1, 0, 0);
 INSERT INTO LUSERS VALUES ('Kibo', 2, 1, 1);
 INSERT INTO ALL_USER_IDS VALUES (0);
 INSERT INTO ALL_USER_IDS VALUES (1);
 INSERT INTO ALL_USER_IDS VALUES (2);
 INSERT INTO LUSER_DATA VALUES ('ROOT1', 0, 'BIFF is a total loser');
 INSERT INTO LUSER_DATA VALUES ('ROOT2', 0, 'Kibo wastes disk space');
 INSERT INTO AUDIT_RECORDS VALUES (0, 0, 1);
 INSERT INTO AUDIT_RECORDS VALUES (0, 0, 1);
 INSERT INTO AUDIT_RECORDS VALUES (2, 2, 1);
 INSERT INTO AUDIT_RECORDS VALUES (1, 1, 0);
 INSERT INTO AUDIT_RECORDS VALUES (1, 1, 0);
 INSERT INTO AUDIT_RECORDS VALUES (1, 1, 0);
 INSERT INTO AUDIT_RECORDS VALUES (1, 1, 0);
 INSERT INTO AUDIT_RECORDS VALUES (1, 1, 0);
 INSERT INTO AUDIT_RECORDS VALUES (1, 1, 0);
 INSERT INTO AUDIT_RECORDS VALUES (2, 2, 0);
 INSERT INTO AUDIT_RECORDS VALUES (2, 2, 2);
 INSERT INTO AUDIT_RECORDS VALUES (2, 2, 1);
 INSERT INTO LUSER_DATA VALUES ('HAHA', 2, 'I G0T KIB0Z PASSW0RD!!!');

 DELETE FROM LUSERS WHERE NAAM <> 'root';
 SELECT COUNT(*) FROM LUSER_DATA;
-- PASS:0645 If count = 2?

 SELECT COUNT(*) FROM LUSERS;
-- PASS:0645 If count = 1?

 SELECT COUNT(*) FROM AUDIT_RECORDS;
-- PASS:0645 If count = 12?

 SELECT COUNT(*) FROM AUDIT_RECORDS WHERE LUSER_ID IS NULL;
-- PASS:0645 If count = 10?

 SELECT COUNT(*) FROM AUDIT_RECORDS WHERE SAVED_LUSER_ID IS NULL;
-- PASS:0645 If count = 0?

 DELETE FROM AUDIT_CODES WHERE LUSER_ACTION = 'DELETE';
-- PASS:0645 If 1 row is deleted?

 SELECT COUNT(*) FROM AUDIT_RECORDS WHERE ACTION_KEY = 2;
-- PASS:0645 If count = 0?

 SELECT COUNT(*) FROM AUDIT_RECORDS WHERE ACTION_KEY = 0;
-- PASS:0645 If count = 8?

 DELETE FROM ALL_USER_IDS;
	-- PASS:0645 If RI ERROR, children exist, 0 rows deleted?

COMMIT;

 DROP TABLE AUDIT_RECORDS ;
-- PASS:0645 If table is dropped?

 DROP TABLE ALL_USER_IDS ;
-- PASS:0645 If table is dropped?

 DROP TABLE AUDIT_CODES ;
-- PASS:0645 If table is dropped?

 DROP TABLE LUSER_DATA ;
-- PASS:0645 If table is dropped?

DROP TABLE LUSERS ;
-- PASS:0645 If table is dropped?

DROP DATABASE;
